<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/favoritos.css">
    <link rel="shortcut icon" href="assets/imgs/icon.png" type="image/x-icon">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.11/jquery.mask.min.js"></script>

    <title>NextView</title>
</head>

<body>

    <div class="dashboard-container">

        <!-- Botão menu lateral -->
        <button class="btn_menu" id="btn_menu_abrir"><img src="assets/imgs/menu-black.png" alt=""></button>

        <aside class="sidebar" id="sidebar_id">

            <!-- Botão para fechar menu lateral -->
            <button class="btn_menu" id="btn_menu_fechar"><img src="assets/imgs/fechar-black.png" alt=""></button>

            <ul id="menu">
                <li><img id="logo" src="assets/imgs/Logo.png" alt=""></li>
                <li>
                    <a href="dashboard.html">
                        <img src="assets/imgs/002-google-analytics.png" alt="Análises">
                        <p>Dashboard</p>
                    </a>
                </li>
                <li>
                    <a href="pesquisa.html">
                        <img src="assets/imgs/ion--search-outline (2).png" alt="Pesquisa">
                        <p>Pesquisar conteúdo</p>
                    </a>
                </li>
                <li>
                    <a href="favoritos.html">
                        <img src="assets/imgs/ion--star-outline.png" alt="Favoritos">
                        <p>Favoritos</p>
                    </a>
                </li>
                <li>
                    <a href="index.html">
                        <img src="assets/imgs/001-sair.png" alt="Sair">
                        <p>Logout</p>
                    </a>
                </li>
            </ul>
        </aside>

        <main class="pesquisa-main">

            <div class="container-perfil">
                <p>Bem Vindo!</p>
                <button onclick="exibirPerfil()"><img src="assets/imgs/perfil-azul.png" alt=""></button>
            </div>

            <div class="pop-up-notification" id="popup">
                <p id="popup-message"></p>
            </div>

            <div class="card-perfil" id="cardPerfil">

                <div class="container-card-info">
                    <h2>Informações de perfil</h2>

                    <hr>

                    <div class="info-item" id="empresa-item">
                        <div>
                            <label>Nome da empresa</label>
                            <input type="text" id="empresa" value="..." disabled>
                        </div>
                        <span class="edit-icon" onclick="habilitarEdit('empresa')"><img class="icon-pencil"
                                src="assets/imgs/ferramenta-lapis.png" alt=""></span>
                    </div>

                    <div class="info-item" id="cnpj-item">
                        <div>
                            <label>CNPJ</label>
                            <input type="text" id="cnpj" value="..." disabled>
                        </div>
                        <span class="edit-icon" onclick="habilitarEdit('cnpj')"><img class="icon-pencil"
                                src="assets/imgs/ferramenta-lapis.png" alt=""></span>
                    </div>

                    <div class="info-item" id="email-item">
                        <div>
                            <label>E-mail</label>
                            <input type="text" id="email" value="..." disabled>
                        </div>
                        <span class="edit-icon" onclick="habilitarEdit('email')"><img class="icon-pencil"
                                src="assets/imgs/ferramenta-lapis.png" alt=""></span>
                    </div>

                    <div class="info-item" id="telefone-item">
                        <div>
                            <label>Telefone</label>
                            <input type="text" id="telefone" value="..." disabled>
                        </div>
                        <span class="edit-icon" onclick="habilitarEdit('telefone')"><img class="icon-pencil"
                                src="assets/imgs/ferramenta-lapis.png" alt=""></span>
                    </div>

                    <button class="confirm-btn" id="confirmBtn"
                        onclick="atualizar(empresa.value, telefone.value,cnpj.value, email.value, sessionStorage.ID_EMPRESA)"
                        disabled>Confirmar</button>
                </div>

            </div>

            <div class="pesquisa-header">
                <span class="pesquisa-title">Favoritos</span>
            </div>

            <div class="filter">

                <div class="filter-date">

                    <button class="filter-date-btn" onclick="exibirAno()">
                        <p>Ano</p>
                        <img src="assets/imgs/seta.png" alt=""></span>
                    </button>

                    <div class="filter-date-content" id="filterDateContent">

                        <span>
                            <p>De:</p>
                            <input id="input_de" type="number"
                                oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                maxlength="4">
                        </span>

                        <span>
                            <p>Até:</p>
                            <input id="input_ate" type="number"
                                oninput="if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                maxlength="4">
                        </span>

                        <button class="confirm-filter-date" onclick="iniciarListarConteudosData(document.getElementById('input_de').value, document.getElementById('input_ate').value)">Confirmar</button>

                        <p id="msg_erro"></p>

                    </div>

                </div>

                <div class="filter-gender">
                    <button class="filter-gender-btn" onclick="exibirGeneros()">
                        <p>Gêneros</p>
                        <img src="assets/imgs/seta.png" alt=""></span>
                    </button>

                    <div class="filter-gender-content" id="filterGenderContent">
                        <label><input type="checkbox"> Terror</label>
                        <hr>
                        <label><input type="checkbox"> Ação</label>
                        <hr>
                        <label><input type="checkbox"> Drama</label>
                        <hr>
                        <label><input type="checkbox"> Ficção</label>
                        <hr>
                        <label><input type="checkbox"> Romance</label>
                        <hr>
                        <label><input type="checkbox"> Suspense</label>
                    </div>
                </div>

            </div>

            <div class="table-container">
                <table class="pesquisa-table" id="table-container">
                    <thead>
                        <tr>
                            <th>Título <span></span></th>
                            <th>Data <span></span></th>
                            <th>Avaliação <span></span></th>
                            <th>Gênero <span></span></th>
                            <th></th>
                        </tr>
                    </thead>
                </table>

                <button onclick="exibirMais()" class="btn-ver-mais">Ver mais...</button>

            </div>

        </main>

    </div>

</body>

</html>

<script type="text/javascript">
    $("#telefone").mask("(00)00000-0000");
</script>

<script type="text/javascript">
    $("#cnpj").mask("00.000.000/0000-00");
</script>

<script>

    function buscarDados() {
        document.getElementById("empresa").value = sessionStorage.NOME_EMPRESA;
        document.getElementById("telefone").value = sessionStorage.TELEFONE_EMPRESA;
        document.getElementById("cnpj").value = sessionStorage.CNPJ_EMPRESA;
        document.getElementById("email").value = sessionStorage.EMAIL_EMPRESA;
    }


    var linhasPassadas = 0;
    var linhasPassadasData = 0;
    var linhasPassadasResultado = 0;
    var tipo = "listarConteudo";
    var listaGenerosCheck = []

    window.onload = iniciarListarConteudos();
    window.onload = buscarDados();

    document.addEventListener('DOMContentLoaded', (event) => {
        var containerGeneros = document.getElementById('filterGenderContent');

        containerGeneros.addEventListener('change', (e) => {

            if (e.target.matches('input[type="checkbox"]')) {

                var checkboxAlterado = e.target;
                var valorDoCheckbox = checkboxAlterado.value;

                if (checkboxAlterado.checked) {
                    listaGenerosCheck.push(valorDoCheckbox)
                }
                if (!checkboxAlterado.checked) {
                    var indice = listaGenerosCheck.indexOf(valorDoCheckbox)
                    listaGenerosCheck.splice(indice, 1);
                }
            }
            iniciarListarConteudosGeneros();
        });
    });

    function iniciarListarConteudos() {
        document.getElementById("table-container").innerHTML = `<thead>
                        <tr>
                            <th>Título <span></span></th>
                            <th>Ano De Lançamento <span></span></th>
                            <th>Avaliação <span></span></th>
                            <th>Gênero <span></span></th>
                        </tr>
                    </thead>`;
        linhasPassadas = 0;
        tipo = "listarConteudo";
        listarConteudos();
    }

    function iniciarListarConteudosGeneros() {
        document.getElementById("table-container").innerHTML = `<thead>
                        <tr>
                            <th>Título <span></span></th>
                            <th>Ano De Lançamento <span></span></th>
                            <th>Avaliação <span></span></th>
                            <th>Gênero <span></span></th>
                        </tr>
                    </thead>`;
        linhasPassadas = 0;
        tipo = "listarConteudo";
        listarConteudosGeneros();
    }

    function iniciarListarConteudosData(de, ate) {
        document.getElementById("table-container").innerHTML = `<thead>
                        <tr>
                            <th>Título <span></span></th>
                            <th>Ano De Lançamento <span></span></th>
                            <th>Avaliação <span></span></th>
                            <th>Gênero <span></span></th>
                        </tr>
                    </thead>`;
        linhasPassadasData = 0;
        tipo = "listarConteudosData";
        listarConteudosData(de, ate);
    }

    function exibirMais() {
        if (tipo == "listarConteudoGeneros") {
            listarConteudosGeneros();
        }

        if (tipo == "listarConteudo") {
            listarConteudos();
        }

        if (tipo == "listarConteudosData") {
            listarConteudosData(document.getElementById('input_de').value, document.getElementById('input_ate').value);
        }
    }

    function listarConteudos() {
        tipo = "listarConteudo"

        fetch(`/favorito/listarPesquisa/${linhasPassadas}/${sessionStorage.ID_EMPRESA}`, {
            method: 'GET'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Erro ao buscar conteudos");
                }
                return response.json();
            })
            .then(dashs => {
                var data = ""
                dashs.forEach(dados => {
                    var data = dados.dtLancamentoCont
                    var partes = data.split('-');
                    var ano = partes[0];

                    document.getElementById("table-container").innerHTML +=
                        `
                    <tr>
                        <td><img id = "filme${dados.fkConteudo}" src="assets/imgs/ion--star.png" class="star" onclick="favoritar('${dados.fkConteudo}')">${dados.tituloConteudo}</td>
                        <td>${ano}</td>
                        <td>${dados.notaConteudo}</td>
                        <td>${dados.generosConteudo}</td>
                    </tr>
                    `
                });
                linhasPassadas += 50
            })
            .catch(error => {
                console.error("Erro ao buscar diretor do momento 2:", error);
            });
    }

       function listarConteudosData(de, ate) {
        tipo = "listarConteudosData";
        fetch(`/favorito/listarPesquisaData/${linhasPassadasData}/${sessionStorage.ID_EMPRESA}/${de}/${ate}`, {
            method: 'GET'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Erro ao buscar diretor do momento");
                }
                return response.json();
            })
            .then(dashs => {
                var data = ""
                dashs.forEach(dados => {
                    var data = dados.dtLancamentoCont
                    var partes = data.split('-');
                    var ano = partes[0];
                    document.getElementById("table-container").innerHTML +=
                        `
                    <tr>
                        <tr>
                        <td><img id = "filme${dados.fkConteudo}" src="assets/imgs/ion--star.png" class="star" onclick="favoritar('${dados.fkConteudo}')">${dados.tituloConteudo}</td>
                        <td>${ano}</td>
                        <td>${dados.notaConteudo}</td>
                        <td>${dados.generosConteudo}</td>
                    </tr>
                    </tr>
                    `
                });
                linhasPassadasData += 50
            })
            .catch(error => {
                console.error("Erro ao buscar diretor do momento 2:", error);
            });
    }


    function favoritar(id) {
        fetch(`/pesquisa/desfavoritar/${id}/${sessionStorage.ID_EMPRESA}`, {
            method: "DELETE"
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);
                iniciarListarConteudos();
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            })
    }

    const paginaAtual = window.location.pathname.split("/").pop();

    const links = document.querySelectorAll("#menu a");

    links.forEach(link => {
        const linkHref = link.getAttribute("href");

        if (paginaAtual === linkHref) {
            link.classList.add("ativo");
        }

        link.addEventListener("click", () => {
            links.forEach(l => l.classList.remove("ativo"));
            link.classList.add("ativo");
        });
    });

    let editDaVez = null;

    function habilitarEdit(id) {

        if (editDaVez && editDaVez !== id) {
            document.getElementById(editDaVez).disabled = true;
            document.getElementById(editDaVez + '-item').classList.remove('active');
        }

        const input = document.getElementById(id);
        const item = document.getElementById(id + '-item');
        input.disabled = false;
        input.focus();
        item.classList.add('active');

        document.getElementById('confirmBtn').disabled = false;

        editDaVez = id;
    }

    function atualizar(empresa, telefone, cnpj, email, id) {

        if (!empresa || !telefone || !cnpj || !email) {

            mostrarPopup("Preencha os dados!", "erro");

        } else {

            var emailRecebido = email
            var telefoneRecebido = removerMascaraAlfanumerica(telefone);
            var cnpjRecebido = removerMascaraAlfanumerica(cnpj);
            var empresaRecebido = empresa
            var idRecebido = id


            fetch("/usuarios/atualizar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    emailServer: emailRecebido,
                    empresaServer: empresaRecebido,
                    cnpjServer: cnpjRecebido,
                    telefoneServer: telefoneRecebido,
                    idServer: idRecebido
                }),
            })
                .then(function (resposta) {
                    console.log("resposta: ", resposta);

                    if (resposta.ok) {

                        sessionStorage.EMAIL_EMPRESA = emailRecebido;
                        sessionStorage.NOME_EMPRESA = empresaRecebido;
                        sessionStorage.ID_EMPRESA = idRecebido;
                        sessionStorage.TELEFONE_EMPRESA = telefoneRecebido;
                        sessionStorage.CNPJ_EMPRESA = cnpjRecebido;
                        mostrarPopup("Dados atualizados!", "sucesso");
                        if (!editDaVez) return;


                        const input = document.getElementById(editDaVez);
                        const item = document.getElementById(editDaVez + '-item');
                        input.disabled = true;
                        item.classList.remove('active');

                        document.getElementById('confirmBtn').disabled = true;

                        editDaVez = null;
                    } else {
                        mostrarPopup("Falha na atualização!", "erro");
                    }

                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                    mostrarPopup("Falha na atualização!", "erro");
                });

        }
    }

    function exibirPerfil() {
        const card = document.getElementById("cardPerfil");
        card.classList.toggle("ativo");
    }

    function mostrarPopup(mensagem, tipo) {

        const popup = document.getElementById('popup');
        const texto = document.getElementById('popup-message');

        texto.textContent = mensagem;

        popup.classList.remove('pop-up-success', 'pop-up-error');
        popup.classList.add(tipo === 'sucesso' ? 'pop-up-success' : 'pop-up-error');

        popup.classList.add('show');

        setTimeout(() => {
            popup.classList.remove('show');
        }, 1500);
    }

    // Funcionalidade menu hambúrguer
    const btnAbrir = document.getElementById('btn_menu_abrir');
    const btnFechar = document.getElementById('btn_menu_fechar');
    const sidebarID = document.getElementById('sidebar_id');

    btnAbrir.addEventListener('click', () => {
        sidebarID.classList.add('aberto');
    });

    btnFechar.addEventListener('click', () => {
        sidebarID.classList.remove('aberto');
    });

    function exibirGeneros() {

        if (filterGenderContent.style.display === 'block') {
            filterGenderContent.style.display = 'none';
        } else {
            filterGenderContent.style.display = 'block';
        }

    }

    function exibirAno() {

        if (filterDateContent.style.display === 'flex') {
            filterDateContent.style.display = 'none';
        } else {
            filterDateContent.style.display = 'flex';
        }

    }

    function confirmarFiltroData() {

        const msgErro = document.getElementById('msg_erro');
        let inputDe = document.getElementById('input_de').value;
        let inputAte = document.getElementById('input_ate').value;

        let anoDe = Number(inputDe);
        let anoAte = Number(inputAte);

        const anoAtual = new Date().getFullYear();

        if (inputDe.trim() === "" || inputAte.trim() === "") {
            msgErro.textContent = "Preencha os campos!";
            msgErro.style.display = 'block';

            limparMensagemErro(msgErro);
            return;
        }

        if (anoDe < 0 || anoAte < 0 || anoDe > anoAtual || anoAte > anoAtual) {
            msgErro.textContent = "Data inválida!";
            msgErro.style.display = 'block';

            limparMensagemErro(msgErro);
            return;
        }

        if (anoDe > anoAte) {
            msgErro.textContent = "Ano inicial deve ser menor que final!";
            msgErro.style.display = 'block';

            limparMensagemErro(msgErro);
            return;
        }

    }

    function limparMensagemErro(msgErro) {
        setTimeout(() => {
            msgErro.style.display = "none";
            msgErro.textContent = "";
        }, 3000);
    }

    function removerMascaraAlfanumerica(mensagem) {
        return mensagem.replace(/[^a-zA-Z0-9]/g, '');
    }

</script>